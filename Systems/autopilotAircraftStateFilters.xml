<?xml version="1.0"?>

<!--
    Autopilot Configuration for the VC10
-->


<PropertyList>

	<!--
    =================================================
    Primary Air Data - Aircraft Speed and Altitude
    =================================================
    -->
	<filter>
		<name>CSI airspeed scale</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<condition>
			<less-than>
				<property>velocities/airspeed-kt</property><value>211</value>
			</less-than>
		</condition>
		<expression>
			<sum>
				<product>
					<value>-0.000033272</value>
					<pow><property>velocities/airspeed-kt</property><value>3</value></pow>
				</product>
				<product>
					<value>+0.013262</value>
					<pow><property>velocities/airspeed-kt</property><value>2</value></pow>
				</product>
				<product>
					<value>-0.60699</value>
					<property>velocities/airspeed-kt</property>
				</product>
				<value>-4.9906</value>
			</sum>
		</expression>
		</input>
		<input>
		<condition>
			<greater-than-equals>
				<property>velocities/airspeed-kt</property><value>211</value>
			</greater-than-equals>
		</condition>
		<expression>
			<sum>
				<product>
					<value>0.00000019453</value>
					<pow><property>velocities/airspeed-kt</property><value>3</value></pow>
				</product>
				<product>
					<value>-0.00058466</value>
					<pow><property>velocities/airspeed-kt</property><value>2</value></pow>
				</product>
				<product>
					<value>+0.75063</value>
					<property>velocities/airspeed-kt</property>
				</product>
				<value>+10.456</value>
			</sum>
		</expression>
		</input>
		<output><property>autopilot/velocities/CSI_airspeed-deg</property></output>
	</filter>
	
	<filter>
		<name>CSI speedbug scale</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<condition>
			<less-than>
				<property>autopilot/settings/HUD_rotation_speed</property><value>211</value>
			</less-than>
		</condition>
		<expression>
			<sum>
				<product>
					<value>-0.000033272</value>
					<pow><property>autopilot/settings/HUD_rotation_speed</property><value>3</value></pow>
				</product>
				<product>
					<value>+0.013262</value>
					<pow><property>autopilot/settings/HUD_rotation_speed</property><value>2</value></pow>
				</product>
				<product>
					<value>-0.60699</value>
					<property>autopilot/settings/HUD_rotation_speed</property>
				</product>
				<value>-4.9906</value>
			</sum>
		</expression>
		</input>
		<input>
		<condition>
			<greater-than-equals>
				<property>autopilot/settings/HUD_rotation_speed</property><value>211</value>
			</greater-than-equals>
		</condition>
		<expression>
			<sum>
				<product>
					<value>0.00000019453</value>
					<pow><property>autopilot/settings/HUD_rotation_speed</property><value>3</value></pow>
				</product>
				<product>
					<value>-0.00058466</value>
					<pow><property>autopilot/settings/HUD_rotation_speed</property><value>2</value></pow>
				</product>
				<product>
					<value>+0.75063</value>
					<property>autopilot/settings/HUD_rotation_speed</property>
				</product>
				<value>+10.456</value>
			</sum>
		</expression>
		</input>
		<output><property>autopilot/velocities/CSI_speedbug-deg</property></output>
	</filter>

	<filter>
		<name>Height acquire setting</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<condition>
				<property>autopilot/switches/height-Acquire</property>
			</condition> 
			<property>autopilot/settings/height-aq-setting</property>
		</input>
		<!--		<input>
			<condition>
				<and>
					<not><property>autopilot/Bendix-PB-20/controls/ALT-active</property></not>
					<not><property>autopilot/switches/height-Acquire</property></not>
				</and>
			</condition>
			<property>instrumentation/altimeter/indicated-altitude-ft</property>
		</input> -->
		<input><property>instrumentation/altimeter/indicated-altitude-ft</property></input>
		<output><property>autopilot/internal/hAcquireD</property></output>
	</filter>

	<filter>
		<name>Static Pressure Datum</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<condition>
				<or>
					<property>autopilot/Bendix-PB-20/controls/ALT-active</property>
					<property>autopilot/switches/height-Acquire</property>
				</or>
			</condition>
			<property>autopilot/internal/sD</property>
		</input>
		<input><property>systems/static/pressure-inhg</property></input>
		<output><property>autopilot/internal/sD</property></output>
	</filter>

	<filter>
		<name>s-sD</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input><property>systems/static/pressure-inhg</property></input>
		<reference><property>autopilot/internal/sD</property></reference>
		<output><property>autopilot/internal/s-sD</property></output>
	</filter>

	<filter>
		<name>HD dot modulus</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<property>autopilot/internal/hD_dot</property>
			<abs type="bool">true</abs>
		</input>
		<output><property>autopilot/internal/hD_dot_abs</property></output>
	</filter>

	<filter>
		<name>HR dot</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<expression>
				<dif>
					<property>autopilot/internal/hAcquireD</property>
					<property>autopilot/internal/hD</property>
				</dif>
			</expression>
		</input>
		<output><property>autopilot/internal/hR_dot</property></output>
	</filter>

	<filter>
		<name>hR dot limited</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input><property>autopilot/internal/hR_dot</property></input>
		<u_min>-133</u_min> 
		<u_max>133</u_max>
		<output><property>autopilot/internal/hR_dot_limited</property></output>
	</filter>

	<filter>
		<name>hR dot rate limited</name>
		<debug>false</debug>
		<type>rate-limit</type>
		<!--		<gain>1.0</gain> -->
		<input><property>autopilot/internal/hR_dot_limited</property></input>
		<max-rate-of-change>257.6</max-rate-of-change>
		<min-rate-of-change>-32.2</min-rate-of-change>		
		<output><property>autopilot/internal/hR_dot_rate_limited</property></output>
	</filter>

	<filter>
		<name>HR dot modulus</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<property>autopilot/internal/hR_dot</property>
			<abs type="bool">true</abs>
		</input>
		<output><property>autopilot/internal/hR_dot_abs</property></output>
	</filter>

	<filter>
		<name>HR dot modulus plus 1</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<sum>
				<property>autopilot/internal/hR_dot_abs</property>
				<value>-1.0</value>
			</sum>
		</input>
		<output><property>autopilot/internal/hR_dot_absp1</property></output>
	</filter>

	<!-- Height acquire flare mode relay  -->
	<logic>
		<input>
			<and>
				<greater-than>
					<property>autopilot/internal/hR_dot_absp1</property>
					<property>autopilot/internal/hD_dot_abs</property>
				</greater-than>
				<or>
					<property>autopilot/Bendix-PB-20/controls/IAS-active</property>
					<property>autopilot/Bendix-PB-20/controls/MACH-active</property>
				</or>
				<property>autopilot/switches/height-Acquire</property>	   
			</and>
		</input>
		<output><property>autopilot/internal/R</property></output>
	</logic>

	<!--
This computes height rate commands from height error.
The height rate command is either
1. Relay R = 0 Height acquire flare (requires a speed hold mode and height acquire mode to activate)
2. Relay R = 1 Default operation
-->
	<filter>
		<name>hD_dot - height rate demand summer amplifier</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<!--		<type>exponential</type>
		<filter-time>0.01</filter-time>  -->
		<input>
			<condition>
				<not><property>autopilot/switches/height-Acquire</property></not>
			</condition>
			<property>autopilot/internal/hR_dot</property>
		</input>
		<input>
			<condition>
				<property>autopilot/internal/R</property>
			</condition>
			<property>autopilot/internal/h-hD</property>
		</input>
		<input>
			<property>autopilot/internal/hR_dot_rate_limited</property>				
		</input>
		<output><property>autopilot/internal/hD_dot</property></output>
		<u_min>-2000</u_min>
		<u_max>2000</u_max>
	</filter>

	<!--
This slews the current height datum by sending inputs to the hD integrator.
The input to the hD integrator is either
1. In LOCK mode - inputs from the Datum Adjust switch on the AFCS panel
2. Not in LOCK mode - computed from height error.
-->
	<filter>
		<name>hD_dot_mt - height rate integrator input</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<condition>
				<property>autopilot/Bendix-PB-20/controls/ALT-active</property>
			</condition>
			<expression><product>
					<property>autopilot/switches/ht-datum-adj</property>
					<value>100.0</value>
				</product></expression>
		</input>
		<input><property>autopilot/internal/hD_dot</property></input>
		<output><property>autopilot/internal/hD_dot_mt</property></output>
		<u_min>-2000</u_min>
		<u_max>2000</u_max>
	</filter>		

	<filter>
		<!-- This integrator was implemented as a servo motor with tachometer (i.e. rate) feedback.
        A potentiometer on the output shaft gives the height demand output (hD) --> 
		<name>height demand hD integrator</name>
		<debug>false</debug>
		<type>integrator</type>
		<gain>1.0</gain>
		<input>
			<expression>
				<product>
					<property>autopilot/internal/hD_dot_mt</property>
					<property>autopilot/gain/GhD_integ</property>
				</product>
			</expression>
		</input>
		<output><property>autopilot/internal/hD</property></output>
		<u_min>0</u_min>
		<u_max>50000</u_max>
	</filter>

	<!--
This slews the current height datum by sending inputs to the hD integrator.
The input to the hD integrator is either
1. In LOCK mode - inputs from the Datum Adjust switch on the AFCS panel
2. Not in LOCK mode - computed from height error.
-->	

	<filter>
		<!-- This integrator was implemented as a servo motor with tachometer (i.e. rate) feedback.
        A potentiometer on the output shaft gives the height lock demand output (hLockD) --> 
		<name>height hold integrator</name>
		<debug>false</debug>
		<type>integrator</type>
		<gain>1.0</gain>
		<input> <!-- Height hold mode - constant altitude, which may be slewed by datum adj sw -->
			<condition>
				<property>autopilot/Bendix-PB-20/controls/ALT-active</property>
			</condition>
			<expression>
				<product>
					<property>autopilot/switches/ht-datum-adj</property>
					<value>100.0</value>
				</product>
			</expression>
		</input>
		<input> <!-- Not in height hold mode - track indicated altitude -->
			<expression>
				<product>
					<dif>
						<property>instrumentation/altimeter/indicated-altitude-ft</property>
						<property>autopilot/internal/hLockD</property>
					</dif>
					<value>10.0</value>
				</product>
			</expression>
		</input>
		<output><property>autopilot/internal/hLockD</property></output>
		<u_min>0</u_min>
		<u_max>50000</u_max>
	</filter>

	<filter>
		<name>hDemand</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<condition>
				<property>autopilot/Bendix-PB-20/controls/ALT-active</property>
			</condition>
			<property>autopilot/internal/hLockD</property>
		</input>
		<input>
			<condition>
				<property>autopilot/switches/height-Acquire</property>
			</condition>
			<property>autopilot/internal/hAcquireD</property>
		</input>
		<input>
			<property>instrumentation/altimeter/indicated-altitude-ft</property>
		</input>
		<output><property>autopilot/internal/hDemand</property></output>
		<u_min>0</u_min>
		<u_max>50000</u_max>
	</filter>

	<filter>
		<name>hDemand rate limit</name>
		<type>noise-spike</type>
		<max-rate-of-change>100.0</max-rate-of-change>
		<input><property>autopilot/internal/hDemand</property></input>
		<output><property>autopilot/internal/hDemandRL</property></output>
	</filter>	

	<filter>
		<name>Height Error h-hDemand</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<expression><dif>
					<property>instrumentation/altimeter/indicated-altitude-ft</property>
					<property>autopilot/internal/hDemandRL</property>
				</dif></expression>
		</input>
		<output><property>autopilot/internal/h-hDemand</property></output>
		<u_min>-2000</u_min>
		<u_max>2000</u_max>
	</filter>

	<filter>
		<name>Height Error h-hAcquire</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<expression><dif>
					<property>instrumentation/altimeter/indicated-altitude-ft</property>
					<property>autopilot/internal/hAcquireD</property>
				</dif></expression>
		</input>
		<output><property>autopilot/internal/h-hAcquireD</property></output>
	</filter>

	<filter>
		<name>Hdot squared</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>
			<expression><product>
					<property>fdm/jsbsim/velocities/h-dot-fps</property>
					<property>fdm/jsbsim/velocities/h-dot-fps</property>
				</product></expression>
		</input>
		<output><property>autopilot/internal/h_dot_sq</property></output>
	</filter>

	<filter>
		<name>hAcquire climb switch</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>		
			<expression><div>
					<property>autopilot/internal/h_dot_sq</property>
					<value>-32.2</value>
				</div></expression>
		</input>
		<output><property>autopilot/internal/hAcquire_climb_sw</property></output>
		<!--<value>-500.0</value> -->
	</filter>

	<filter>
		<name>hAcquire dive switch</name>
		<debug>false</debug>
		<type>gain</type>
		<gain>1.0</gain>
		<input>		
			<expression><div>
					<property>autopilot/internal/h_dot_sq</property>
					<value>100.0</value>
				</div></expression>
		</input>
		<output><property>autopilot/internal/hAcquire_dive_sw</property></output>
		<!--<value>60.0</value> -->
	</filter>	

	<logic>
		<name>height acquired flag</name>
		<input>
			<and>
				<property>autopilot/switches/height-Acquire</property>
				<or>
					<property>autopilot/Bendix-PB-20/controls/MACH-active</property>
					<property>autopilot/Bendix-PB-20/controls/IAS-active</property>
				</or>
				<less-than>
					<property>autopilot/internal/h-hAcquireD</property>
					<value>1500</value>
				</less-than>
				<greater-than>
					<property>autopilot/internal/h-hAcquireD</property>
					<value>-1500</value>
				</greater-than>
				<or>
					<property>autopilot/internal/h-Acquired_flag</property>
					<and>
						<less-than>
							<property>autopilot/internal/h-hAcquireD</property>
							<!--<value>60</value> -->
							<property>autopilot/internal/hAcquire_dive_sw</property>
						</less-than>
						<greater-than>
							<property>autopilot/internal/h-hAcquireD</property>
							<!--<value>-500.0</value>  -->
							<property>autopilot/internal/hAcquire_climb_sw</property>
						</greater-than>
					</and>					
				</or>p
			</and>
		</input>
		<output><property>autopilot/internal/h-Acquired_flag</property></output>
	</logic>

	<state-machine>
		<branch>autopilot/logic/acquire_height</branch>
		<state>
			<name>engaged</name>
		</state>
		<state>
			<name>acquiring_height</name>
		</state>
		<state>
			<name>acquired_height</name>
		</state>
		<transition>
			<name>AQ_HT</name>
			<source>acquiring_height</source>
			<target>acquired_height</target>
			<condition></condition>
		</transition>
		<transition>
			<name>LOCK_HT</name>
			<source>acquired_height</source>
			<target>acquiring_height</target>
			<condition></condition>
		</transition>
	</state-machine>

</PropertyList>
